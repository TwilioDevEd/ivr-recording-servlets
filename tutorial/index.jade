.chapter(data-title='IVR Phone Tree')
  .step(data-file='src/main/webapp/WEB-INF/web.xml')
    :markdown
      ## About this application

      ![Extra Terrestrial Phone Home
      Service](//howtodocs.s3.amazonaws.com/logo-et-phone2.png)

      This Java Servlets sample application is modeled after a typical call
      center experience, but with more [Reese's Pieces](//en.wikipedia.org/wiki/Reese%27s_Pieces#ET:_The_Extra-
      Terrestrial).

      Stranded aliens can call a phone number and receive instructions on how to
      get out of earth safely, or call their [home planet](//bit.ly/asogi)
      directly. In this tutorial, we'll show you the key bits of code that allow
      an agent to send a caller to voicemail, and later read transcripts and
      listen to voicemails.

      To run this sample app yourself, [download the code and follow the
      instructions on GitHub](//github.com/TwilioDevEd/ivr-recording-servlets).

      Let's get started! Click the right arrow above to move to the next step
      of the tutorial.

      ---

      **See Also:**
      * [ET IVR Part One: Phone
      Trees](//www.twilio.com/docs/howto/walkthrough/ivr-phone-tree/java/servlets)
      * [Getting Started with Java Servlets](//docs.oracle.com/javaee/6/tutorial/doc/bnafd.html)
      * [Getting Started with Gradle Java/JVM](//gradle.org/getting-started-gradle-java/)
      * [Twilio Rest API](//www.twilio.com/docs/api/rest)
      * [Twilio Java helper library](//www.twilio.com/docs/java/install)

  .step(data-file='src/main/java/com/twilio/ivrrecording/servlet/extension/ConnectServlet.java',
  data-highlight='27-60')
    :markdown
      ## Route the call to an agent

      When our caller chooses a planet we need to figure out where to route the
      call. Depending on her input we will route this call to an extension. In
      this case an extension will be used to look up an Agent, so any string
      can be used to define an extension.

      Once we lookup the `Agent`, we can `<Dial>` the agent's phone number and try
      to connect the call. Let's look at those steps next.

      ---

      **See Also:**
      * [TwiML Dial](//www.twilio.com/docs/api/twiml/dial)


  .step(data-file='src/main/java/com/twilio/ivrrecording/servlet/extension/ConnectServlet.java',
  data-highlight='70-80')
    :markdown
      ## Looking up an Agent

      In this case the Agent model is very simple. The migration used to create it:

      ```
      @Entity
      @Table(name = "agents")
      public class Agent {

         @Id
         @GeneratedValue(strategy = GenerationType.IDENTITY)
         @Column(name = "id")
         private long id;

         @Column(name = "extension")
         private String extension;

         @Column(name = "phone_number")
         private String phoneNumber;

         @OneToMany(mappedBy = "agent")
         private List<Recording> recordings;

         ...
      }

      ```

      We have a handle or `extension` that we can use to lookup an Agent, and
      we have a `phoneNumber` that we will call.


  .step(data-file='src/main/java/com/twilio/ivrrecording/servlet/extension/ConnectServlet.java', data-highlight='41-58')
    :markdown
      ## Call the Agent

      This code begins the process of transferring the call to our agent.

      By passing a `url` to the `Dial` > [`Number`](//www.twilio.com/docs/api/twiml/number)
      TwiML tag, we are telling Twilio to make a POST request to the
      `agents/call` route _after_ the agent has picked up but _before_
      connecting the two parties.

      Essentially we are telling Twilio to execute some TwiML that only the
      agent will hear. Let's look at that next.

      ---

      **See Also:**
      * [TwiML Say verb](//www.twilio.com/docs/api/twiml/say)


  .step(data-file='src/main/java/com/twilio/ivrrecording/servlet/agent/ScreenCallServlet.java',
  data-highlight='13-48')
    :markdown
      ## The Agent screens the call

      When our agent picks up their phone, we use a
      [Gather](https://www.twilio.com/docs/api/twiml/gather) verb to ask
      them if they want to accept the call.

      If the agent enters any digit the
      response will be processed by our `agents/message` route (below)
      which will `<Say>` a quick message, then continue with the original
      `<Dial>` command and connect the two parties.

      If the agent instead does not respond, the `<Dial>` process will end and Twilio will look to the URL we
      provided for more instructions - we'll look at that route next.

      ---

      **See Also:**
      * [The Gather action attribute](//www.twilio.com/docs/api/twiml/gather#attributes-action)


  .step(data-file='src/main/java/com/twilio/ivrrecording/servlet/agent/CallServlet.java',
  data-highlight='16-54')
    :markdown
      ## Send the Caller to Voicemail

      When Twilio makes a request to our voicemail controller, it will pass a
      [`DialCallStatus`](//www.twilio.com/docs/api/twiml/dial#attributes-action-dial-call-status-values)
      which will tell us if the call was successful. If it was "completed" we
      hangup â€” otherwise we need to `<Say>` a quick prompt and then
      [Record](//www.twilio.com/docs/api/twiml/record) a voicemail from
      the caller.

      We also specify an `action` for `<Record>`. This route will be
      called after the call (and hence the recording) has finished. The route
      will say "Goodbye" and then [Hangup](//www.twilio.com/docs/api/twiml/hangup).

      ---

      **See Also:**
      * [Twilio Request
        parameters](//www.twilio.com/docs/api/twiml/twilio_request#synchronous-request-parameters)


  .step(data-file='src/main/java/com/twilio/ivrrecording/servlet/record/CreateServlet.java',
  data-highlight='31-41')
    :markdown
      ## Record the Caller

      When we tell Twilio to Record we have a few
      [options](//www.twilio.com/docs/api/twiml/record#attributes) we can
      pass to the `Record` verb.

      Here we instruct Record to stop the recording at 20 seconds, to
      [`transcribe`](//www.twilio.com/docs/api/twiml/record#attributes-transcribe)
      the call, and where to send the transcription when it's
      complete. Adding the `transcribeCallback` attribute to
      `<Record>` implies `transcribe = true`.

      Notice we redirect to an URL that is specific to an agent. This
      is a convenient way to specify which agent was called to produce
      this voice message. This way we can also save the associated
      agent together with the voicemail.

      ---

      **See Also:**
      * [Twilio transcribeCallback](//www.twilio.com/docs/api/twiml/record#attributes-transcribe-callback)

  .step(data-file='src/main/java/com/twilio/ivrrecording/servlet/agent/AgentsServlet.java',
  data-highlight='28-31')
    :markdown
      ## View an Agent's Voicemails

      Once we look up the Agent, all we need to do is display all of her
      recordings. We simply bind the agent with its recordings to a view that
      is then rendered.

      It is possible to look up recordings via the Twilio REST API,
      but since we have all of the data we need in the
      `transcribeCallback` request, we can easily store it ourselves
      and save a roundtrip.

      ---

      **See Also:**
      * [Twilio REST API: Recordings](//www.twilio.com/docs/api/rest/recording)
      * [Twilio REST API: Transcription Resource](//www.twilio.com/docs/api/rest/transcription)

  .step
    :markdown
      ## Where to next?

      That's it! We've just implemented an IVR with real Agents, call
      screening and voicemail. If you're a C# developer working with
      Twilio, you might want to check out these other tutorials.

      [**Part 1 of this Tutorial: ET Phone Home Service - IVR Phone
      Trees**](//www.twilio.com/docs/howto/walkthrough/ivr-phone-tree/java/servlets)

      Increase your rate of response by automating the workflows that are key to
      your business.

      [**SMS and MMS Notifications**](//www.twilio.com/docs/tutorials/walkthrough/server-notifications/java/servlets)

      Send out SMS (and MMS) notifications to a list of server administrators.

      ### Did this help?

      Thanks for checking out this tutorial! If you have any feedback
      to share with us, we'd love to hear it. Tweet
      [@twilio](//twitter.com/twilio) to let us know what you
      think.
